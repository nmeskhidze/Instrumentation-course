<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upwind Footprint (Interactive)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body style="font-family: sans-serif; margin: 20px;">

  <h2>Interactive Upwind Footprint</h2>

  <div>
    <label>Sensor height (m): <span id="heightVal">20</span></label>
    <input type="range" id="height" min="2" max="100" step="1" value="20">
  </div>
  <div>
    <label>Stability: </label>
    <select id="stability">
      <option value="unstable">Unstable</option>
      <option value="neutral" selected>Neutral</option>
      <option value="stable">Stable</option>
    </select>
  </div>

  <div id="plot" style="width: 800px; height: 500px;"></div>

  <script>
    // Gamma PDF function
    function gammaPDF(x, k, theta) {
      if (x <= 0) return 0;
      return Math.pow(x, k-1) * Math.exp(-x/theta) / (Math.pow(theta, k) * gammaFunc(k));
    }

    // Approximate Gamma function (Lanczos approximation)
    function gammaFunc(z) {
      const g = 7;
      const p = [
        0.99999999999980993, 676.5203681218851,
        -1259.1392167224028, 771.32342877765313,
        -176.61502916214059, 12.507343278686905,
        -0.13857109526572012, 9.9843695780195716e-6,
        1.5056327351493116e-7
      ];
      if(z < 0.5) {
        return Math.PI / (Math.sin(Math.PI*z) * gammaFunc(1-z));
      }
      z -= 1;
      let x = p[0];
      for(let i = 1; i < g+2; i++) {
        x += p[i] / (z + i);
      }
      let t = z + g + 0.5;
      return Math.sqrt(2*Math.PI) * Math.pow(t, z+0.5) * Math.exp(-t) * x;
    }

    function footprint(z, stability) {
      const kMap = {unstable: 1.8, neutral: 2.2, stable: 3.0};
      const sMap = {unstable: 0.6, neutral: 1.0, stable: 1.8};
      let k = kMap[stability];
      // base scale depends only on sensor height now
      let baseScale = z * 10.0;
      let theta = baseScale * sMap[stability];
      let x = [];
      let f = [];
      let xmax = Math.max(300, 12*baseScale);
      let n = 800;
      for (let i=0; i<n; i++) {
        let xi = i * xmax / (n-1);
        x.push(xi);
        f.push(gammaPDF(xi, k, theta));
      }
      // Normalize numerically
      let area = 0;
      for (let i=1; i<n; i++) {
        area += 0.5*(f[i]+f[i-1])*(x[i]-x[i-1]);
      }
      f = f.map(v => v/area);
      return {x:x, f:f, k:k, theta:theta};
    }

    function updatePlot() {
      let z = parseFloat(document.getElementById("height").value);
      let stability = document.getElementById("stability").value;
      document.getElementById("heightVal").innerText = z;
      let data = footprint(z, stability);
      let xPeak = Math.max(0,(data.k-1)*data.theta);
      Plotly.newPlot('plot', [{
        x: data.x,
        y: data.f,
        type: 'scatter',
        mode: 'lines',
        line: {color:'blue'}
      },{
        x:[xPeak,xPeak],
        y:[0,Math.max(...data.f)],
        mode:'lines',
        line:{dash:'dot',color:'black'}
      }], {
        title: `Upwind Footprint<br>height=${z} m, stability=${stability}`,
        xaxis:{title:'Upwind distance x (m)'},
        yaxis:{title:'Footprint density f(x) (1/m)'}
      });
    }

    document.getElementById("height").oninput = updatePlot;
    document.getElementById("stability").onchange = updatePlot;

    // Initial plot
    updatePlot();
  </script>
</body>
</html>
